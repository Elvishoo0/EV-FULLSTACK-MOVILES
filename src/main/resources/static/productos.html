<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Catálogo</title>

  <!-- Tu CSS global -->
  <link rel="stylesheet" href="/css/main.css" />

  <!-- usa mismo host del backend para evitar CORS -->
  <script>window.API_BASE = '/api';</script>

  <style>
    /* Estilo mínimo del listado */
    .wrap { width:min(1100px,95%); margin: 100px auto 40px; }
    .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:14px; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px; }
    .title { font-weight:700; line-height:1.3; }
    .price { font-weight:700; opacity:.95; }
    .btn  { cursor:pointer; border:none; border-radius:10px; padding:10px 12px; font-weight:700; background:#2E8B57; color:#fff; }
    .muted{ opacity:.7; }
    .cart-pill { background:#eee; border-radius:999px; padding:6px 10px; font-weight:700; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h2>Productos</h2>
      <a href="/" class="muted">← Volver al inicio</a>
    </div>

    <div id="status" class="muted">Cargando catálogo…</div>
    <div id="grid" class="grid" aria-live="polite" hidden></div>
  </div>

  <script>
    const CLP = new Intl.NumberFormat('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits:0 });
    const grid   = document.getElementById('grid');
    const status = document.getElementById('status');

    // carrito simple en localStorage
    let cart = JSON.parse(localStorage.getItem('hh_cart') || '{}');
    const saveCart = () => localStorage.setItem('hh_cart', JSON.stringify(cart));
    const addToCart = (id) => { cart[id] = (cart[id]||0) + 1; saveCart(); toast('Producto agregado'); };

    function toast(msg){
      status.textContent = msg;
      status.classList.remove('muted');
      setTimeout(()=>{ status.textContent = ''; status.classList.add('muted'); }, 1200);
    }

    function render(list){
      grid.innerHTML = '';
      list.forEach(p=>{
        const art = document.createElement('article');
        art.className = 'card';
        art.dataset.id = p.id;
        art.innerHTML = `
          <div class="title">${p.nombre}</div>
          <div class="price">${CLP.format(Number(p.precio)||0)}</div>
          <button class="btn" type="button">Agregar al carrito</button>
        `;
        art.querySelector('.btn').addEventListener('click', ()=> addToCart(p.id));
        grid.appendChild(art);
      });
      status.textContent = '';
      grid.hidden = false;
    }

    fetch(`${window.API_BASE}/productos`)
      .then(r=>{ if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
      .then(data => {
        if(!Array.isArray(data) || data.length===0){
          status.textContent = 'No hay productos cargados.';
          return;
        }
        render(data);
      })
      .catch(err=>{
        console.error('Error /api/productos', err);
        status.textContent = 'No se pudo cargar el catálogo. Reintenta más tarde.';
      });
  </script>
</body>
</html>
